<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Guía mapa Carboneras & Níjar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(18, 24, 38, 0.75);
      --text: #e8edf2;
      --muted: #a9b3c1;
      --accent: #58c4d7;
      --accent-2: #81e6d9;
      --card: #ffffff;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      --radius: 10px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #map {
      position: absolute;
      inset: 0;
    }

    /* Panel superior de controles */
    .control-bar {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      background: var(--panel);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 2;
    }

    .control-bar label {
      font-size: 14px;
      color: var(--muted);
      letter-spacing: 0.2px;
    }

    #language-selector {
      appearance: none;
      padding: 8px 12px;
      font-size: 15px;
      color: #0f172a;
      border-radius: 8px;
      border: 1px solid #d0d8e3;
      background: linear-gradient(#fff, #f7fafc);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 1px 2px rgba(0, 0, 0, 0.05);
      cursor: pointer;
    }

    /* Estilo de marcador */
    .marker {
    width: 56px;
    height: 56px;
    background-size: cover;
    background-position: center;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    transition: transform 80ms ease; /* antes 140ms */
    cursor: pointer;
  }
  .marker:hover,
  .marker:focus {
    transform: scale(1.02); /* menos rebote */
    outline: none;
  }

    /* Popups */
    .mapboxgl-popup {
      max-width: 360px;
    }

    .mapboxgl-popup-content {
      padding: 12px 12px 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    .popup-title {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: #0f172a;
      letter-spacing: 0.2px;
    }

    .popup-media {
      width: 100%;
      margin-bottom: 8px;
      border-radius: 8px;
      overflow: hidden;
      background: #f2f5f8;
      border: 1px solid #eef2f7;
    }

    .popup-description {
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 10px;
      padding-right: 6px;
      font-size: 14px;
      line-height: 1.45;
      color: #1f2937;
    }

    .popup-description::-webkit-scrollbar {
      width: 8px;
    }

    .popup-description::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.18);
      border-radius: 4px;
    }

    .popup-description a {
      color: #0b7ddc;
      text-decoration: underline;
      font-weight: 600;
    }

    .popup-description a:hover {
      color: #0a66b2;
    }

    audio, video {
      width: 100%;
    border: none;
    border-top: 2px solid #60c1df; /* línea continua clara */
    padding-top: 4px;
    margin-top: 8px;
    border-radius: 0;
    background: transparent;
    }

    /* Toast (mensajes sutiles) */
    .toast {
      position: absolute;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
      font-size: 14px;
      display: none;
      z-index: 2;
    }

    @media (max-width: 600px) {
      .control-bar {
        right: 12px;
      }
      .mapboxgl-popup {
        max-width: 92vw;
      }
    }
  </style>
</head>
<body>
  <div class="control-bar" role="region" aria-label="Controles del mapa">
    <label for="language-selector">Idioma</label>
    <select id="language-selector" aria-label="Selecciona idioma">
      <option value="es" selected>🇪🇸 Español</option>
      <option value="en">🇬🇧 English</option>
      <option value="fr">🇫🇷 Français</option>
    </select>
  </div>

  <div id="map" aria-label="Mapa interactivo de Carboneras y Níjar"></div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibmVwdGVjaG5vbG9neSIsImEiOiJjbWRkZW1sNzQwM2JqMm1xdzUyZWsyNXBzIn0.NqcQR3KhSFBlAKR_nvQsqw';

    // Límites navegables aproximados del área
    const bounds = [
      [-1.994104, 36.897126], // SO
      [-1.876345, 36.998783]  // NE
    ];

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/standard-satellite',
      center: [-1.897802, 36.990419],
      zoom: 14.8,
      pitch: 64,
      bearing: 288,
      maxBounds: bounds
    });


    function scaleMarkers() {
    const zoom = map.getZoom();
    const baseSize = 56; // tamaño base en px
    const scale = Math.max(0.5, Math.min(1.2, zoom / 15)); 
    document.querySelectorAll('.marker').forEach(m => {
      m.style.width = baseSize * scale + 'px';
      m.style.height = baseSize * scale + 'px';
    });
  }

  map.on('zoom', scaleMarkers);
  map.on('load', () => {
    scaleMarkers();
  });

    // Controles de mapa
    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new mapboxgl.FullscreenControl(), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({ unit: 'metric' }), 'bottom-right');
    map.addControl(new mapboxgl.GeolocateControl({
      positionOptions: { enableHighAccuracy: true },
      trackUserLocation: true,
      showUserHeading: true
    }), 'top-right');

    // Toast
    function showToast(message, duration = 3500) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => (toast.style.display = 'none'), duration);
    }

    // Marcador de usuario (geolocalización continua)
    let userMarker;
    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          const userCoords = [longitude, latitude];

          if (userMarker) {
            userMarker.setLngLat(userCoords);
          } else {
            userMarker = new mapboxgl.Marker({ color: '#2563eb' })
              .setLngLat(userCoords)
              .setPopup(new mapboxgl.Popup({ offset: 20 }).setText('Tu ubicación'))
              .addTo(map);

            map.flyTo({ center: userCoords, zoom: 15, speed: 0.6 });
          }
        },
        (error) => {
          console.error('Error de geolocalización:', error);
          showToast('No se pudo obtener tu ubicación. Revisa los permisos del navegador.');
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
      );
    }

    // Datos
    const Puntos = [
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/salida.png',
        videoUrl: '',
        lnglat: [-1.897802, 36.990419],
        nombre: {
          es: 'Salida: Puerto de Carboneras',
          en: 'Start: Port of Carboneras',
          fr: 'Départ : Port de Carboneras'
        },
        description: {
          es: `Inaugurado en 1991 por los Reyes de España, el puerto pesquero de Carboneras es uno de los más activos de la costa mediterránea. Aquí puedes vivir de cerca la estampa marinera: barcos palangreros, de arrastre y de cerco; redes tendidas al sol; y casetas de pescadores que conservan el encanto tradicional. La flota palangrera de Carboneras, especializada en atún rojo y pez espada, es de las más destacadas del Mediterráneo. En el puerto se encuentra la lonja, que acoge cada tarde la subasta de pescado recién capturado, después presente en los restaurantes del municipio. No te vayas sin probar la gamba roja de Carboneras, capturada en aguas profundas frente a su costa: un emblema de la gastronomía local por su sabor intenso y textura jugosa. También son típicos los <a href="https://www.fishipedia.es/pez/xyrichtys-novacula" target="_blank" rel="noopener noreferrer">galanes</a>, de carne blanca y delicada, y los <a href="https://www.fishipedia.es/pez/bothus-podas" target="_blank" rel="noopener noreferrer">tapaculos</a>, muy comunes en estas aguas.`,
          en: `Opened in 1991 by the King and Queen of Spain, the fishing port of Carboneras is among the most active on the Mediterranean coast. Here you can soak up maritime life up close: longliners, trawlers and purse seiners; nets drying in the sun; and fishermen’s huts that still retain their traditional charm. Carboneras’ longline fleet, specializing in bluefin tuna and swordfish, is one of the most prominent in the Mediterranean. The fish market hosts a daily afternoon auction of freshly landed catch, later featured across town restaurants. Don’t leave without tasting Carboneras’ red prawn, caught in deep local waters—celebrated for its intense flavor and succulent texture. Also typical are the <a href="https://www.fishipedia.es/pez/xyrichtys-novacula" target="_blank" rel="noopener noreferrer">galanes (pearlsides wrasse)</a> and the <a href="https://www.fishipedia.es/pez/bothus-podas" target="_blank" rel="noopener noreferrer">tapaculos (wide-eyed flounder)</a>, both common here.`,
          fr: `Inauguré en 1991 par les Rois d’Espagne, le port de pêche de Carboneras compte parmi les plus actifs de la côte méditerranéenne. On y découvre la vie maritime de près : palangriers, chalutiers et senneurs ; filets séchant au soleil ; cabanes de pêcheurs au charme intact. La flotte palangrière, spécialisée dans le thon rouge et l’espadon, est l’une des plus notables de Méditerranée. La criée organise chaque après-midi la vente aux enchères de poissons fraîchement débarqués, que l’on retrouve ensuite sur les tables des restaurants. Ne partez pas sans goûter à la crevette rouge de Carboneras, pêchée en eaux profondes : un emblème local pour sa saveur intense et sa texture juteuse. Sont aussi typiques les <a href="https://www.fishipedia.es/pez/xyrichtys-novacula" target="_blank" rel="noopener noreferrer">galanes</a> et les <a href="https://www.fishipedia.es/pez/bothus-podas" target="_blank" rel="noopener noreferrer">tapaculos</a>, très présents dans ces eaux.`
        },
        audioUrl: { es: 'audio/salida-es.mp3', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/isla.png',
        videoUrl: 'video/isla.mp4',
        lnglat: [-1.885625, 36.992776],
        nombre: {
          es: 'Isla de San Andrés',
          en: 'San Andrés Island',
          fr: 'Île de San Andrés'
        },
        description: {
          es: `A solo 400 metros de la costa de Carboneras se alza la Isla de San Andrés, una formación volcánica de unos 15.000 m<sup>2</sup> declarada Monumento Natural por su gran valor ecológico. Es uno de los lugares más emblemáticos del municipio y un faro para los amantes del mar. Bajo sus aguas se esconde un paraíso submarino: fondos rocosos con grietas, cuevas y praderas marinas donde observar meros, serranos, castañuelas, doncellas, tordos verdes, sargos, mojarras, obladas, espetones e incluso corvinas y peces luna en primavera. Puedes contratar rutas en kayak para rodearla sin desembarcar o bucear en sus fondos rocosos para contemplar de cerca su vida marina.`,
          en: `Just 400 meters off the Carboneras coastline rises San Andrés Island, a volcanic formation of around 15,000 m<sup>2</sup> declared a Natural Monument for its ecological significance. It’s an emblematic spot and a beacon for sea lovers. Beneath the surface lies an underwater paradise: rocky beds with fissures, caves and seagrass meadows hosting groupers, combers, damselfish, wrasses, green wrasse, black and white seabream, two-banded seabream, barracudas, and even croakers and ocean sunfish in spring. Book a kayak tour to circle the island without landing, or dive the rocky bottoms to get closer to its marine life.`,
          fr: `À seulement 400 mètres du littoral de Carboneras se dresse l’île de San Andrés, formation volcanique d’environ 15 000 m<sup>2</sup> classée Monument naturel pour sa grande valeur écologique. Lieu emblématique et repère des amoureux de la mer, elle abrite un véritable paradis sous-marin : fonds rocheux, fissures, grottes et prairies marines où observer mérous, serrans, castagnoles, demoiselles, girelles, sars, bogues, oblades, barracudas et, au printemps, corvinas et poissons-lunes. Des sorties en kayak permettent d’en faire le tour, ou bien on peut plonger pour admirer de plus près sa vie marine.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/castillo.png',
        videoUrl: '',
        lnglat: [-1.894318, 36.996523],
        nombre: {
          es: 'Castillo de San Andrés',
          en: 'San Andrés Castle',
          fr: 'Château de San Andrés'
        },
        description: {
          es: `Construido entre finales del siglo XVI y 1621 por orden de Luis López de Haro, marqués de Carpio, con permiso de Felipe II, este castillo vigilaba la costa frente a ataques piratas. Su sólida fábrica de mampostería luce tres torres cilíndricas y una gran torre en el ángulo sur, coronada por matacán defensivo y el escudo de los Carpio sobre la entrada. Marcó el origen del núcleo urbano de Carboneras: se repartieron tierras a los soldados para favorecer su asentamiento. En su interior hubo viviendas, almacenes, caballerizas y una capilla dedicada a San Andrés. Declarado Bien de Interés Cultural (BIC) en 1993, ha sido restaurado y hoy acoge actividades culturales y la oficina de turismo.`,
          en: `Built between the late 16th century and 1621 by order of Luis López de Haro, Marquis of Carpio, with permission from Philip II, this castle guarded the coast from pirate raids. Its sturdy masonry features three cylindrical towers and a larger southern tower crowned with a defensive machicolation and the Carpio coat of arms above the main gate. It marked the birth of Carboneras’ urban core: land was granted to soldiers to encourage settlement. Inside stood homes, stores, stables and a chapel dedicated to Saint Andrew. Declared a Site of Cultural Interest (BIC) in 1993, it has been restored and now hosts cultural events and the tourist office.`,
          fr: `Édifié entre la fin du XVIᵉ siècle et 1621 sur ordre de Luis López de Haro, marquis de Carpio, avec l’autorisation de Philippe II, ce château surveillait la côte contre les attaques de pirates. Sa solide maçonnerie présente trois tours cylindriques et une grande tour au sud, couronnée d’un mâchicoulis défensif, avec le blason des Carpio au-dessus de l’entrée. Il a marqué la naissance du noyau urbain de Carboneras : des terres furent attribuées aux soldats pour favoriser leur installation. Il abritait des logements, des magasins, des écuries et une chapelle dédiée à Saint André. Classé Bien d’intérêt culturel (BIC) en 1993, il a été restauré ; il accueille aujourd’hui des activités culturelles et l’office de tourisme.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/faro.png',
        videoUrl: '',
        lnglat: [-1.906756, 36.94169],
        nombre: {
          es: 'Faro de Mesa Roldán',
          en: 'Mesa Roldán Lighthouse',
          fr: 'Phare de Mesa Roldán'
        },
        description: {
          es: `Situado a 220 m sobre el nivel del mar, en lo alto de una antigua formación volcánica, el Faro de Mesa Roldán regala una de las vistas más impresionantes del Parque Natural Cabo de Gata‑Níjar. A solo 7 km de Carboneras y 4 km de Agua Amarga, se inauguró en 1863 y lleva más de 160 años guiando a los navegantes. Su luz, visible hasta 23 millas náuticas, supuso un antes y un después en la seguridad marítima de la zona, donde antaño apenas se encendían hogueras en la torre vigía. Cómo llegar: desde el aparcamiento de la Playa de los Muertos, toma la carretera asfaltada que sube a la cima (bien señalizada, con algunas curvas). Curiosidad: en 1934 una nevada cubrió de hielo sus cristales—una estampa poco común aquí.`,
          en: `Perched 220 m above sea level on an ancient volcanic rise, Mesa Roldán Lighthouse offers one of the most breathtaking views in Cabo de Gata‑Níjar Natural Park. Just 7 km from Carboneras and 4 km from Agua Amarga, it was inaugurated in 1863 and has guided sailors for over 160 years. Its light, visible up to 23 nautical miles, marked a turning point in local maritime safety, where previously only bonfires blazed from the old watchtower. Getting there: from Playa de los Muertos parking, take the paved road to the summit (well signposted, with a few sharp bends). Fun fact: in 1934, snowfall iced over its windowpanes—an exceedingly rare sight here.`,
          fr: `Perché à 220 m d’altitude au sommet d’une ancienne formation volcanique, le phare de Mesa Roldán offre l’un des plus beaux panoramas du parc naturel de Cabo de Gata‑Níjar. À 7 km de Carboneras et 4 km d’Agua Amarga, il fut inauguré en 1863 et guide les marins depuis plus de 160 ans. Sa lumière, visible jusqu’à 23 milles nautiques, a transformé la sécurité maritime locale, là où l’on n’allumait auparavant que des feux de guet. Accès : depuis le parking de la plage de los Muertos, empruntez la route asphaltée jusqu’au sommet (bien indiquée, avec quelques virages). Anecdote : en 1934, une chute de neige glaça ses vitres—un spectacle rarissime ici.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/torre.png',
        videoUrl: '',
        lnglat: [-1.90933, 36.941622],
        nombre: {
          es: 'Torre de Mesa Roldán',
          en: 'Mesa Roldán Tower',
          fr: 'Tour de Mesa Roldán'
        },
        description: {
          es: `En un promontorio entre la Punta de los Muertos y la Punta de Media Naranja, junto al faro homónimo, esta torre vigía domina el horizonte a más de 220 m sobre el mar. Se construyó en 1766 sobre restos de defensas anteriores de origen musulmán y nazarí. Su peculiar silueta, conocida como “torre de pezuña”, la hace única. Ya en la Edad Media existió aquí una atalaya frente a incursiones vikingas y berberiscas. Con la Reconquista, la Corona reforzó estas defensas y Mesa Roldán llegó a ser uno de los puntos más estratégicos (y peligrosos) de la costa almeriense: los guardas percibían un plus por el riesgo. Geológicamente, es un domo volcánico submarino coronado por un arrecife fósil de coral de hace seis millones de años, responsable de su cima plana. Hoy la torre está muy deteriorada. Acceso: basta ascender unos metros a pie desde el faro. Curiosidad: Juego de Tronos rodó aquí escenas gracias a su paisaje dramático y su atmósfera única.`,
          en: `On a headland between Punta de los Muertos and Punta de Media Naranja, beside the lighthouse, this watchtower commands the horizon over 220 m above the sea. Built in 1766 upon earlier Muslim and Nasrid structures, its unusual “hoof-shaped” plan makes it unique. A lookout already stood here in the Middle Ages against Viking and Berber raids. During the Reconquista the Crown strengthened these defenses, making Mesa Roldán one of the most strategic (and perilous) points along the Almerían coast; guards received hazard pay. Geologically, it’s an ancient submarine volcanic dome topped by a six‑million‑year‑old fossil coral reef, giving it a flat summit. The tower today is heavily deteriorated. Access: walk a few meters uphill from the lighthouse. Fun fact: Game of Thrones filmed scenes here for its dramatic landscape and atmosphere.`,
          fr: `Sur un promontoire entre Punta de los Muertos et Punta de Media Naranja, à côté du phare, cette tour de guet domine l’horizon à plus de 220 m d’altitude. Construite en 1766 sur des vestiges d’origine musulmane et nasride, sa forme singulière en « sabot » la rend unique. Une vigie existait déjà ici au Moyen Âge pour se prémunir des raids vikings et berbères. Avec la Reconquête, la Couronne renforça ces défenses et Mesa Roldán devint l’un des points les plus stratégiques (et périlleux) de la côte d’Almería ; les gardes y percevaient une prime de risque. Géologiquement, il s’agit d’un dôme volcanique sous‑marin surmonté d’un récif corallien fossile vieux de six millions d’années, à l’origine de son sommet plat. La tour est aujourd’hui très détériorée. Accès : quelques mètres à pied depuis le phare. Anecdote : Game of Thrones y a tourné des scènes, séduite par ce décor spectaculaire.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/playamuertos.png',
        videoUrl: '',
        lnglat: [-1.89872, 36.953514],
        nombre: {
          es: 'Playa de los Muertos',
          en: 'Playa de los Muertos',
          fr: 'Playa de los Muertos'
        },
        description: {
          es: `Considerada entre las playas más bellas de España, pertenece a Carboneras y se halla en el Parque Natural Cabo de Gata‑Níjar. Famosa por sus aguas turquesa y su entorno virgen, se encaja entre acantilados y formaciones volcánicas que dibujan un paisaje de impacto. Cómo llegar: desde Carboneras, toma la carretera hacia Agua Amarga y aparca en el parking habilitado junto al mirador y el punto de información. Desde allí, un sendero de unos 20 minutos a pie desciende hasta la playa. ¿Sabías por qué se llama «de los Muertos»? El nombre recuerda un temporal de 1869 que atrapó a varios pescadores bajo la Mesa Roldán; cinco fallecieron pese al rescate, y con el tiempo otros naufragios afianzaron la toponimia.`,
          en: `Ranked among Spain’s most beautiful beaches, it belongs to Carboneras and lies within the Cabo de Gata‑Níjar Natural Park. Its crystal‑clear turquoise waters and pristine setting are framed by cliffs and volcanic formations. Getting there: from Carboneras, drive toward Agua Amarga and park near the viewpoint and tourist info point. From there, a 20‑minute footpath leads down to the beach. Why the name “of the Dead”? It recalls a 1869 storm that trapped fishermen beneath Mesa Roldán; five perished despite rescue efforts, and later shipwrecks cemented the somber toponym.`,
          fr: `Considérée comme l’une des plus belles plages d’Espagne, elle relève de Carboneras et se situe dans le parc naturel de Cabo de Gata‑Níjar. Eaux turquoise cristallines, cadre vierge, falaises et formations volcaniques composent un décor spectaculaire. Accès : depuis Carboneras, prenez la route d’Agua Amarga et garez‑vous près du belvédère et du point d’information. De là, un sentier d’environ 20 minutes descend jusqu’à la plage. Pourquoi « des Morts » ? Le nom évoque une tempête de 1869 qui piégea des pêcheurs sous la Mesa Roldán ; cinq périrent malgré les secours, et d’autres naufrages ont fixé la toponymie.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/calaenmedio.png',
        videoUrl: '',
        lnglat: [-1.946871, 36.932317],
        nombre: {
          es: 'Cala de Enmedio',
          en: 'Cala de Enmedio',
          fr: 'Cala de Enmedio'
        },
        description: {
          es: `Pequeña y resguardada, destaca por sus aguas transparentes y su paisaje volcánico. Su acceso exigente ha preservado intacta su belleza, perfecta para quienes buscan calma y naturaleza en estado puro. Ideal para snorkel en aguas claras y ricas en vida. Las formaciones y acantilados que la rodean son un imán para fotografía y senderismo. Cómo llegar: desde Agua Amarga, sigue el sendero costero hacia Cala del Plomo y continúa ~1 km más (≈1 h 15 min). Desde Cala del Plomo, un paseo señalizado de unos 20 minutos entre rocas volcánicas conduce a esta joya escondida.`,
          en: `Tucked away and sheltered, it stands out for glass‑clear waters and a volcanic setting. The demanding access has kept it pristine—a haven for quiet and unspoiled nature. Excellent for snorkeling in lively, transparent waters. Surrounding formations and cliffs are a treat for hikers and photographers. Getting there: from Agua Amarga, follow the coastal trail toward Cala del Plomo and continue ~1 km (≈1 h 15 min). From Cala del Plomo, a signed 20‑minute walk over volcanic rock leads to this hidden gem.`,
          fr: `Petite et abritée, elle séduit par ses eaux limpides et son décor volcanique. L’accès exigeant a préservé sa beauté intacte—havre idéal pour qui cherche calme et nature. Parfaite pour le snorkeling en eaux claires et poissonneuses. Ses formations et falaises attirent randonneurs et photographes. Accès : depuis Agua Amarga, suivez le sentier côtier vers la Cala del Plomo et continuez ~1 km (≈1 h 15). Depuis la Cala del Plomo, un itinéraire balisé d’environ 20 minutes parmi les roches volcaniques mène à ce joyau caché.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/calasanpedro.png',
        videoUrl: '',
        lnglat: [-1.979374, 36.900086],
        nombre: {
          es: 'Cala de San Pedro',
          en: 'Cala de San Pedro',
          fr: 'Cala de San Pedro'
        },
        description: {
          es: `Un rincón casi secreto del Parque Natural, famoso por su carácter salvaje. Aguas cristalinas, arena clara y fondo rocoso, junto a la antigua Torre de San Pedro (s. XVI), levantada para vigilar la costa ante piratas. Sin carreteras ni urbanización, conserva un encanto especial: ideal para desconectar, hacer snorkel y pasar un día de playa en paz. Cómo llegar: desde Las Negras, sendero costero de ~4 km (≈1 h), con algunas pendientes; lleva calzado adecuado y agua. ¿Sabías que…? Desde los años 80 vive aquí una pequeña comunidad autosuficiente, sin red de agua ni electricidad, abastecida por un manantial y un estilo de vida sencillo.`,
          en: `A near‑secret nook of the Natural Park, famed for its wild feel. Crystal waters, pale sand and a rocky seabed lie beside the 16th‑century San Pedro Tower, raised to guard the coast from pirates. With no roads or urban sprawl, it keeps a singular charm—perfect to unplug, snorkel and while away a peaceful beach day. Getting there: from Las Negras, a coastal trail of ~4 km (≈1 h) with some climbs; bring good shoes and water. Did you know? Since the 1980s, a small self‑sufficient community lives here, off‑grid and supplied by a spring.`,
          fr: `Un recoin presque secret du parc, réputé pour sa sauvagerie. Eaux cristallines, sable clair et fond rocheux, aux côtés de l’ancienne tour de San Pedro (XVIᵉ s.), érigée pour protéger la côte des pirates. Sans routes ni urbanisation, la crique conserve un charme unique : idéale pour déconnecter, faire du snorkeling et profiter d’une journée paisible. Accès : depuis Las Negras, sentier côtier d’environ 4 km (≈1 h) avec quelques pentes ; emportez de l’eau et de bonnes chaussures. Le saviez‑vous ? Depuis les années 1980, une petite communauté autosuffisante vit ici, hors réseau et alimentée par une source.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/industrial.png',
        videoUrl: '',
        lnglat: [-1.907877, 36.976458],
        nombre: {
          es: 'Zona industrial de Carboneras',
          en: 'Carboneras Industrial Area',
          fr: 'Zone industrielle de Carboneras'
        },
        description: {
          es: `Tras la playa de Las Martinicas se abre la zona industrial de Carboneras, que concentra en poco espacio una notable diversidad de actividades. El contraste con los paisajes que aguardan en el Parque Natural Cabo de Gata‑Níjar no puede ser mayor. Entre las industrias destaca la antigua central térmica de Endesa, cerrada desde hace años y hoy en desmantelamiento. La planta desaladora de Carboneras, una de las mayores de Europa, dio un respiro a un territorio marcado por la sequía—con algunas de las menores precipitaciones de Europa occidental—y abastece consumo humano y regadío en el Campo de Níjar y los municipios del Levante Almeriense y Bajo Almanzora.`,
          en: `Beyond Las Martinicas Beach lies Carboneras’ industrial zone, packing a wide array of activities into a compact area—a striking counterpoint to the natural park ahead. Notable here is Endesa’s former thermal power plant, shut down years ago and now being dismantled. The Carboneras desalination plant—among the largest in Europe—has eased the burden of drought in this arid region, where rainfall is among the lowest in Western Europe; its water supports both households and irrigation across Campo de Níjar and the Levante Almeriense/Bajo Almanzora municipalities.`,
          fr: `Après la plage de Las Martinicas s’étend la zone industrielle de Carboneras, où se concentre une grande diversité d’activités—contraste saisissant avec le parc naturel tout proche. On y remarque l’ancienne centrale thermique d’Endesa, fermée depuis des années et en cours de démantèlement. L’usine de dessalement de Carboneras, l’une des plus vastes d’Europe, a soulagé un territoire marqué par la sécheresse—l’un des moins arrosés d’Europe occidentale—et approvisionne en eau potable et d’irrigation le Campo de Níjar ainsi que les communes du Levante Almeriense et du Bas Almanzora.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/cargadero.png',
        videoUrl: '',
        lnglat: [-1.929275, 36.939143],
        nombre: {
          es: 'Cargadero de mineral de Agua Amarga',
          en: 'Agua Amarga Mineral Loading Dock',
          fr: 'Quai de chargement de minerai d’Agua Amarga'
        },
        description: {
          es: `Los restos del cargadero de mineral evocan un capítulo reciente de la historia almeriense: su esplendor minero. Para localizar el antiguo muelle, basta buscar el peñón en el mar sobre el que se apoyaba. Medía 70 m de longitud y se situaba a 14 m sobre el nivel del mar. Era el extremo de la línea férrea entre Lucainena de las Torres y Agua Amarga; se eligió este punto por estar resguardado de los vientos de levante. Por aquí se embarcaba el hierro de Sierra Alhamilla. El ferrocarril comenzó a operar en 1896 y en 1942, tras años de actividad intermitente, zarpó el último vapor desde el muelle. Agotados los filones, se desmantelaron las instalaciones para llevar el hierro a Almería y fundirlo.`,
          en: `The remains of the mineral loading dock recall a not‑too‑distant chapter in Almería’s past: its mining heyday. To find the old pier, look for the offshore rock that supported it. The structure was 70 m long and stood 14 m above sea level. It marked the terminus of the railway from Lucainena de las Torres to Agua Amarga, chosen here for shelter from easterly winds. Iron from Sierra Alhamilla shipped out from this point. The line began service in 1896, and in 1942—after intermittent activity—the last steamer sailed from the pier. Once the veins were exhausted, the facilities were dismantled and the metal taken to Almería for smelting.`,
          fr: `Les vestiges du quai de chargement de minerai évoquent un chapitre récent de l’histoire d’Almería : son âge d’or minier. Pour situer l’ancien appontement, repérez l’îlot rocheux qui le soutenait. Il mesurait 70 m de long et s’élevait à 14 m au‑dessus du niveau de la mer. Terminus de la voie ferrée Lucainena de las Torres—Agua Amarga, l’endroit fut choisi car abrité des vents d’est. Le fer de la Sierra Alhamilla partait d’ici. La ligne entra en service en 1896 et, en 1942—après une activité intermittente—le dernier vapeur quitta le quai. Les filons épuisés, les installations furent démontées et le métal transporté à Almería pour y être fondu.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/aguamarga.png',
        videoUrl: '',
        lnglat: [-1.935512, 36.940243],
        nombre: {
          es: 'Agua Amarga',
          en: 'Agua Amarga',
          fr: 'Agua Amarga'
        },
        description: {
          es: `Dejamos Carboneras y entramos en el término de Níjar, donde nos recibe la pedanía de Agua Amarga. La pesca, la minería y hoy el turismo han marcado su identidad. Alineado con la playa se extiende el antiguo barrio pesquero, de casas bajas y encaladas. Más allá aparecen dos calas emblemáticas del Parque Natural: Enmedio y del Plomo. En el paisaje destacan los blancos acantilados de calizas arrecifales.`,
          en: `Leaving Carboneras, we enter the municipality of Níjar and the hamlet of Agua Amarga. Fishing, mining and now tourism have shaped its identity. Aligned with the beach lies the former fishing quarter, with low, whitewashed houses. Beyond it are two emblematic coves of the Natural Park: Enmedio and del Plomo. The white cliffs of reef limestone stand out in the scenery.`,
          fr: `Nous quittons Carboneras pour entrer à Níjar, accueillis par le hameau d’Agua Amarga. La pêche, l’activité minière puis le tourisme ont forgé son identité. Le long de la plage s’étend l’ancien quartier des pêcheurs, aux maisons basses et blanchies à la chaux. Plus loin, deux criques emblématiques du parc naturel : Enmedio et del Plomo. Les falaises blanches de calcaires récifaux dominent le paysage.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      },
      {
        iconUrl: 'img/marcador2.png',
        imageUrl: 'img/calaplomo.png',
        videoUrl: '',
        lnglat: [-1.954915, 36.922761],
        nombre: {
          es: 'Cala del Plomo',
          en: 'Cala del Plomo',
          fr: 'Cala del Plomo'
        },
        description: {
          es: `A la derecha encontramos la Cala del Plomo. Es de las más concurridas por su acceso relativamente sencillo por tierra. Sus aguas, muy someras, y su arena fina le dan un aspecto cristalino. En el paisaje llaman la atención los blancos acantilados que la enmarcan.`,
          en: `On the right lies Cala del Plomo. It’s busier than most thanks to relatively easy land access. Very shallow waters and fine sand give it a crystalline look. The surrounding white cliffs complete the scene.`,
          fr: `Sur la droite se trouve la Cala del Plomo. Plus fréquentée que d’autres en raison d’un accès terrestre aisé. Ses eaux peu profondes et son sable fin lui confèrent une transparence cristalline. Les falaises blanches environnantes complètent le décor.`
        },
        audioUrl: { es: '', en: '', fr: '' }
      }
    ];

    // Gestión de marcadores para evitar duplicados al cambiar de idioma
    const markers = [];
    const languageSelector = document.getElementById('language-selector');

    function getPopupHTML(point, lang) {
      const title = point.nombre[lang] || point.nombre.es;
      const desc = point.description[lang] || point.description.es;
      const img = point.imageUrl ? `
        <img class="popup-media" src="${point.imageUrl}" alt="${title}" loading="lazy" />
      ` : '';
      const vid = point.videoUrl ? `
        <video class="popup-media" src="${point.videoUrl}" controls playsinline></video>
      ` : '';
      const audioSrc = point.audioUrl && point.audioUrl[lang] ? point.audioUrl[lang] : '';

      return `
        <h3 class="popup-title">${title}</h3>
        ${img}
        <div class="popup-description">${desc}</div>
        ${vid}
        ${audioSrc ? `<audio src="${audioSrc}" controls></audio>` : ''}
      `;
    }

    function createMarker(point, lang) {
      const el = document.createElement('div');
      el.className = 'marker';
      el.style.backgroundImage = `url(${point.iconUrl})`;
      el.tabIndex = 0;
      el.setAttribute('role', 'button');
      el.setAttribute('aria-label', point.nombre[lang] || point.nombre.es);

      const popup = new mapboxgl.Popup({ offset: 28 })
        .setHTML(getPopupHTML(point, lang));

      popup.on('open', () => {
        const el = popup.getElement();
        const box = el ? el.querySelector('.popup-description') : null;
        if (box) box.scrollTop = 0;
      });

      const marker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
        .setLngLat(point.lnglat)
        .setPopup(popup)
        .addTo(map);

      return { marker, popup, el, point };
    }

    function initMarkers(lang = 'es') {
      Puntos.forEach(p => markers.push(createMarker(p, lang)));
    }

    function updateLanguage(lang) {
      markers.forEach(m => {
        m.popup.setHTML(getPopupHTML(m.point, lang));
        m.el.setAttribute('aria-label', m.point.nombre[lang] || m.point.nombre.es);
      });
    }

    languageSelector.addEventListener('change', (e) => {
      const lang = e.target.value;
      updateLanguage(lang);
      showToast(
        lang === 'es' ? 'Idioma: Español' :
        lang === 'en' ? 'Language: English' : 'Langue : Français',
        1800
      );
    });

    // Render inicial
    initMarkers('es');
  </script>
</body>